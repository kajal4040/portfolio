import { Directive, Input, Renderer2, ElementRef, } from "@angular/core";
import { ScrollService } from "./scroll.service";
import { Subscription } from "rxjs";
export class AnimateOnScrollDirective {
    constructor(elementRef, renderer, scroll) {
        this.elementRef = elementRef;
        this.renderer = renderer;
        this.scroll = scroll;
        this.scrollSub = new Subscription();
        this.resizeSub = new Subscription();
        // Pixel offset from screen bottom to the animated element to determine the start of the animation
        this.offset = 80; // for scroll Listener
    }
    get id() {
        return this.elementRef.nativeElement.id;
    }
    ngOnInit() {
        if (!this.animationName) {
            return;
        }
        // default visibility to false
        this.isVisible = false;
        this.useScroll = this.useScroll
            ? this.useScroll
            : this.useScroll === false
                ? false
                : true;
        this.threshold = this.threshold ? this.threshold || 0.5 : 0.5;
        // using intersecting observer by default, else fallback to scroll Listener
        if ("IntersectionObserver" in window && this.useScroll) {
            const options = {
                root: null,
                threshold: this.threshold,
                rootMargin: "0px",
            };
            const observer = new IntersectionObserver((entries, _) => {
                entries.forEach((entry) => {
                    if (!entry.isIntersecting) {
                        return;
                    }
                    this.addAnimationClass();
                });
            }, options);
            observer.observe(this.elementRef.nativeElement);
            return;
        }
        // subscribe to scroll event using service
        this.scrollSub = this.scroll.scrollObs.subscribe(() => this.manageVisibility());
        // subscribe to resize event using service so scrolling position is always accurate
        this.resizeSub = this.scroll.resizeObs.subscribe(() => this.manageVisibility());
    }
    ngAfterViewInit() {
        // run visibility check initially in case the element is already visible in viewport
        setTimeout(() => this.manageVisibility(), 1);
    }
    ngOnDestroy() {
        this.scrollSub.unsubscribe();
        this.resizeSub.unsubscribe();
    }
    /**
     * check for visibility of element in viewport to add animation
     *
     * @returns void
     */
    manageVisibility() {
        if (this.isVisible) {
            // Optimisation; nothing to do if class has already been applied
            return;
        }
        // check for window height, may change with a window resize
        this.getWinHeight();
        // get vertical position for selected element
        this.getOffsetTop();
        // we should trigger the addition of the animation class a little after getting to the element
        const scrollTrigger = this.offsetTop + this.offset - this.winHeight;
        // using values updated in service
        if (this.scroll.pos >= scrollTrigger) {
            this.addAnimationClass();
        }
    }
    /**
     * utility function to mark element visible and add css class
     *
     * @returns void
     */
    addAnimationClass() {
        // stops execution if no class is provided
        if (!this.animationName) {
            return;
        }
        // mark this element visible, we won't remove the class after this
        this.isVisible = true;
        // use default for animate.css if no value provided
        this.setClass(this.animationName);
    }
    /**
     * utility function to add one or more css classes to element in DOM
     *
     * @param  {string} classes
     * @returns void
     */
    setClass(classes) {
        for (const c of classes.split(" ")) {
            this.renderer.addClass(this.elementRef.nativeElement, c);
        }
    }
    /**
     * get window height utility function
     *
     * @returns void
     */
    getWinHeight() {
        this.winHeight = typeof window !== "undefined" ? window.innerHeight : 0;
    }
    /**
     * get offsetTop value for element
     *
     * @returns void
     */
    getOffsetTop() {
        if (typeof this.elementRef.nativeElement.getBoundingClientRect === "function") {
            const viewportTop = this.elementRef.nativeElement.getBoundingClientRect().top;
            const clientTop = this.elementRef.nativeElement.clientTop;
            // get vertical position for selected element
            this.offsetTop = viewportTop + this.scroll.pos - clientTop;
        }
        else {
            this.offsetTop = 0;
        }
    }
}
AnimateOnScrollDirective.decorators = [
    { type: Directive, args: [{
                // eslint-disable-next-line @angular-eslint/directive-selector
                selector: "[animateOnScroll]",
            },] }
];
AnimateOnScrollDirective.ctorParameters = () => [
    { type: ElementRef },
    { type: Renderer2 },
    { type: ScrollService }
];
AnimateOnScrollDirective.propDecorators = {
    animationName: [{ type: Input }],
    offset: [{ type: Input }],
    useScroll: [{ type: Input }],
    threshold: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYW5pbWF0ZS1vbi1zY3JvbGwuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmcyLWFuaW1hdGUtb24tc2Nyb2xsL3NyYy9saWIvYW5pbWF0ZS1vbi1zY3JvbGwuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLFNBQVMsRUFDVCxVQUFVLEdBSVgsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFNcEMsTUFBTSxPQUFPLHdCQUF3QjtJQW1CbkMsWUFDVSxVQUFzQixFQUN0QixRQUFtQixFQUNuQixNQUFxQjtRQUZyQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsV0FBTSxHQUFOLE1BQU0sQ0FBZTtRQWhCdkIsY0FBUyxHQUFpQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQzdDLGNBQVMsR0FBaUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQU9yRCxrR0FBa0c7UUFDekYsV0FBTSxHQUFXLEVBQUUsQ0FBQyxDQUFDLHNCQUFzQjtJQVFqRCxDQUFDO0lBZEosSUFBWSxFQUFFO1FBQ1osT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUM7SUFDMUMsQ0FBQztJQWNELFFBQVE7UUFDTixJQUFJLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUN2QixPQUFPO1NBQ1I7UUFDRCw4QkFBOEI7UUFDOUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFDdkIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsU0FBUztZQUM3QixDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVM7WUFDaEIsQ0FBQyxDQUFDLElBQUks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SSxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ2xDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLENBQUMsQ0FBQyxDQUFDO1NBQzFEO0lBQ0gsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxZQUFZO1FBQ2xCLElBQUksQ0FBQyxTQUFTLEdBQUcsT0FBTyxNQUFNLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUVEOzs7O09BSUc7SUFDSyxZQUFZO1FBQ2xCLElBQ0UsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsS0FBSyxVQUFVLEVBQ3pFO1lBQ0EsTUFBTSxXQUFXLEdBQ2YsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMscUJBQXFCLEVBQUUsQ0FBQyxHQUFHLENBQUM7WUFDNUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDO1lBRTFELDZDQUE2QztZQUM3QyxJQUFJLENBQUMsU0FBUyxHQUFHLFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUM7U0FDNUQ7YUFBTTtZQUNMLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1NBQ3BCO0lBQ0gsQ0FBQzs7O1lBdktGLFNBQVMsU0FBQztnQkFDVCw4REFBOEQ7Z0JBQzlELFFBQVEsRUFBRSxtQkFBbUI7YUFDOUI7OztZQVhDLFVBQVU7WUFEVixTQUFTO1lBTUYsYUFBYTs7OzRCQW9CbkIsS0FBSztxQkFFTCxLQUFLO3dCQUNMLEtBQUs7d0JBQ0wsS0FBSyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgSW5wdXQsXG4gIFJlbmRlcmVyMixcbiAgRWxlbWVudFJlZixcbiAgT25Jbml0LFxuICBPbkRlc3Ryb3ksXG4gIEFmdGVyVmlld0luaXQsXG59IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBTY3JvbGxTZXJ2aWNlIH0gZnJvbSBcIi4vc2Nyb2xsLnNlcnZpY2VcIjtcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gXCJyeGpzXCI7XG5cbkBEaXJlY3RpdmUoe1xuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGFuZ3VsYXItZXNsaW50L2RpcmVjdGl2ZS1zZWxlY3RvclxuICBzZWxlY3RvcjogXCJbYW5pbWF0ZU9uU2Nyb2xsXVwiLFxufSlcbmV4cG9ydCBjbGFzcyBBbmltYXRlT25TY3JvbGxEaXJlY3RpdmVcbiAgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSwgQWZ0ZXJWaWV3SW5pdFxue1xuICBwcml2YXRlIG9mZnNldFRvcDogbnVtYmVyO1xuICBwcml2YXRlIGlzVmlzaWJsZTogYm9vbGVhbjtcbiAgcHJpdmF0ZSB3aW5IZWlnaHQ6IG51bWJlcjtcbiAgcHJpdmF0ZSBzY3JvbGxTdWI6IFN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcbiAgcHJpdmF0ZSByZXNpemVTdWI6IFN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuICBwcml2YXRlIGdldCBpZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudC5pZDtcbiAgfVxuXG4gIEBJbnB1dCgpIGFuaW1hdGlvbk5hbWU6IHN0cmluZyB8IG51bGw7IC8vIHVzZSBmYWRlSW4gYXMgZGVmYXVsdCBpZiBub3Qgc3BlY2lmaWVkLCBzcGVjaWZ5IG51bGwgZm9yIG5vIGFuaW1hdGlvblxuICAvLyBQaXhlbCBvZmZzZXQgZnJvbSBzY3JlZW4gYm90dG9tIHRvIHRoZSBhbmltYXRlZCBlbGVtZW50IHRvIGRldGVybWluZSB0aGUgc3RhcnQgb2YgdGhlIGFuaW1hdGlvblxuICBASW5wdXQoKSBvZmZzZXQ6IG51bWJlciA9IDgwOyAvLyBmb3Igc2Nyb2xsIExpc3RlbmVyXG4gIEBJbnB1dCgpIHVzZVNjcm9sbD86IGJvb2xlYW47XG4gIEBJbnB1dCgpIHRocmVzaG9sZD86IG51bWJlcjsgLy8gZm9yIGludGVyc2VjdGlvbiBvYnNlcnZlciBvbmx5IGZvciB0aGUgdGltZSBiZWluZ1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZixcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJpdmF0ZSBzY3JvbGw6IFNjcm9sbFNlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5hbmltYXRpb25OYW1lKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIC8vIGRlZmF1bHQgdmlzaWJpbGl0eSB0byBmYWxzZVxuICAgIHRoaXMuaXNWaXNpYmxlID0gZmFsc2U7XG4gICAgdGhpcy51c2VTY3JvbGwgPSB0aGlzLnVzZVNjcm9sbFxuICAgICAgPyB0aGlzLnVzZVNjcm9sbFxuICAgICAgOiB0aGlzLnVzZVNjcm9sbCA9PT0gZmFsc2VcbiAgICAgID8gZmFsc2VcbiAgICAgIDogdHJ1ZTtcbiAgICB0aGlzLnRocmVzaG9sZCA9IHRoaXMudGhyZXNob2xkID8gdGhpcy50aHJlc2hvbGQgfHwgMC41IDogMC41O1xuICAgIC8vIHVzaW5nIGludGVyc2VjdGluZyBvYnNlcnZlciBieSBkZWZhdWx0LCBlbHNlIGZhbGxiYWNrIHRvIHNjcm9sbCBMaXN0ZW5lclxuICAgIGlmIChcIkludGVyc2VjdGlvbk9ic2VydmVyXCIgaW4gd2luZG93ICYmIHRoaXMudXNlU2Nyb2xsKSB7XG4gICAgICBjb25zdCBvcHRpb25zOiBJbnRlcnNlY3Rpb25PYnNlcnZlckluaXQgPSB7XG4gICAgICAgIHJvb3Q6IG51bGwsXG4gICAgICAgIHRocmVzaG9sZDogdGhpcy50aHJlc2hvbGQsXG4gICAgICAgIHJvb3RNYXJnaW46IFwiMHB4XCIsXG4gICAgICB9O1xuICAgICAgY29uc3Qgb2JzZXJ2ZXI6IEludGVyc2VjdGlvbk9ic2VydmVyID0gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKFxuICAgICAgICAoZW50cmllcywgXykgPT4ge1xuICAgICAgICAgIGVudHJpZXMuZm9yRWFjaCgoZW50cnkpID0+IHtcbiAgICAgICAgICAgIGlmICghZW50cnkuaXNJbnRlcnNlY3RpbmcpIHtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhpcy5hZGRBbmltYXRpb25DbGFzcygpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgICBvcHRpb25zXG4gICAgICApO1xuICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gc3Vic2NyaWJlIHRvIHNjcm9sbCBldmVudCB1c2luZyBzZXJ2aWNlXG4gICAgdGhpcy5zY3JvbGxTdWIgPSB0aGlzLnNjcm9sbC5zY3JvbGxPYnMuc3Vic2NyaWJlKCgpID0+XG4gICAgICB0aGlzLm1hbmFnZVZpc2liaWxpdHkoKVxuICAgICk7XG5cbiAgICAvLyBzdWJzY3JpYmUgdG8gcmVzaXplIGV2ZW50IHVzaW5nIHNlcnZpY2Ugc28gc2Nyb2xsaW5nIHBvc2l0aW9uIGlzIGFsd2F5cyBhY2N1cmF0ZVxuICAgIHRoaXMucmVzaXplU3ViID0gdGhpcy5zY3JvbGwucmVzaXplT2JzLnN1YnNjcmliZSgoKSA9PlxuICAgICAgdGhpcy5tYW5hZ2VWaXNpYmlsaXR5KClcbiAgICApO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIC8vIHJ1biB2aXNpYmlsaXR5IGNoZWNrIGluaXRpYWxseSBpbiBjYXNlIHRoZSBlbGVtZW50IGlzIGFscmVhZHkgdmlzaWJsZSBpbiB2aWV3cG9ydFxuICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5tYW5hZ2VWaXNpYmlsaXR5KCksIDEpO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zY3JvbGxTdWIudW5zdWJzY3JpYmUoKTtcbiAgICB0aGlzLnJlc2l6ZVN1Yi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIGNoZWNrIGZvciB2aXNpYmlsaXR5IG9mIGVsZW1lbnQgaW4gdmlld3BvcnQgdG8gYWRkIGFuaW1hdGlvblxuICAgKlxuICAgKiBAcmV0dXJucyB2b2lkXG4gICAqL1xuICBwcml2YXRlIG1hbmFnZVZpc2liaWxpdHkoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNWaXNpYmxlKSB7XG4gICAgICAvLyBPcHRpbWlzYXRpb247IG5vdGhpbmcgdG8gZG8gaWYgY2xhc3MgaGFzIGFscmVhZHkgYmVlbiBhcHBsaWVkXG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gY2hlY2sgZm9yIHdpbmRvdyBoZWlnaHQsIG1heSBjaGFuZ2Ugd2l0aCBhIHdpbmRvdyByZXNpemVcbiAgICB0aGlzLmdldFdpbkhlaWdodCgpO1xuXG4gICAgLy8gZ2V0IHZlcnRpY2FsIHBvc2l0aW9uIGZvciBzZWxlY3RlZCBlbGVtZW50XG4gICAgdGhpcy5nZXRPZmZzZXRUb3AoKTtcblxuICAgIC8vIHdlIHNob3VsZCB0cmlnZ2VyIHRoZSBhZGRpdGlvbiBvZiB0aGUgYW5pbWF0aW9uIGNsYXNzIGEgbGl0dGxlIGFmdGVyIGdldHRpbmcgdG8gdGhlIGVsZW1lbnRcbiAgICBjb25zdCBzY3JvbGxUcmlnZ2VyID0gdGhpcy5vZmZzZXRUb3AgKyB0aGlzLm9mZnNldCAtIHRoaXMud2luSGVpZ2h0O1xuXG4gICAgLy8gdXNpbmcgdmFsdWVzIHVwZGF0ZWQgaW4gc2VydmljZVxuICAgIGlmICh0aGlzLnNjcm9sbC5wb3MgPj0gc2Nyb2xsVHJpZ2dlcikge1xuICAgICAgdGhpcy5hZGRBbmltYXRpb25DbGFzcygpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiB1dGlsaXR5IGZ1bmN0aW9uIHRvIG1hcmsgZWxlbWVudCB2aXNpYmxlIGFuZCBhZGQgY3NzIGNsYXNzXG4gICAqXG4gICAqIEByZXR1cm5zIHZvaWRcbiAgICovXG4gIHByaXZhdGUgYWRkQW5pbWF0aW9uQ2xhc3MoKTogdm9pZCB7XG4gICAgLy8gc3RvcHMgZXhlY3V0aW9uIGlmIG5vIGNsYXNzIGlzIHByb3ZpZGVkXG4gICAgaWYgKCF0aGlzLmFuaW1hdGlvbk5hbWUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBtYXJrIHRoaXMgZWxlbWVudCB2aXNpYmxlLCB3ZSB3b24ndCByZW1vdmUgdGhlIGNsYXNzIGFmdGVyIHRoaXNcbiAgICB0aGlzLmlzVmlzaWJsZSA9IHRydWU7XG5cbiAgICAvLyB1c2UgZGVmYXVsdCBmb3IgYW5pbWF0ZS5jc3MgaWYgbm8gdmFsdWUgcHJvdmlkZWRcbiAgICB0aGlzLnNldENsYXNzKHRoaXMuYW5pbWF0aW9uTmFtZSk7XG4gIH1cblxuICAvKipcbiAgICogdXRpbGl0eSBmdW5jdGlvbiB0byBhZGQgb25lIG9yIG1vcmUgY3NzIGNsYXNzZXMgdG8gZWxlbWVudCBpbiBET01cbiAgICpcbiAgICogQHBhcmFtICB7c3RyaW5nfSBjbGFzc2VzXG4gICAqIEByZXR1cm5zIHZvaWRcbiAgICovXG4gIHByaXZhdGUgc2V0Q2xhc3MoY2xhc3Nlczogc3RyaW5nKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBjIG9mIGNsYXNzZXMuc3BsaXQoXCIgXCIpKSB7XG4gICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCBjKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogZ2V0IHdpbmRvdyBoZWlnaHQgdXRpbGl0eSBmdW5jdGlvblxuICAgKlxuICAgKiBAcmV0dXJucyB2b2lkXG4gICAqL1xuICBwcml2YXRlIGdldFdpbkhlaWdodCgpOiB2b2lkIHtcbiAgICB0aGlzLndpbkhlaWdodCA9IHR5cGVvZiB3aW5kb3cgIT09IFwidW5kZWZpbmVkXCIgPyB3aW5kb3cuaW5uZXJIZWlnaHQgOiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIGdldCBvZmZzZXRUb3AgdmFsdWUgZm9yIGVsZW1lbnRcbiAgICpcbiAgICogQHJldHVybnMgdm9pZFxuICAgKi9cbiAgcHJpdmF0ZSBnZXRPZmZzZXRUb3AoKTogdm9pZCB7XG4gICAgaWYgKFxuICAgICAgdHlwZW9mIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCA9PT0gXCJmdW5jdGlvblwiXG4gICAgKSB7XG4gICAgICBjb25zdCB2aWV3cG9ydFRvcCA9XG4gICAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnRvcDtcbiAgICAgIGNvbnN0IGNsaWVudFRvcCA9IHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LmNsaWVudFRvcDtcblxuICAgICAgLy8gZ2V0IHZlcnRpY2FsIHBvc2l0aW9uIGZvciBzZWxlY3RlZCBlbGVtZW50XG4gICAgICB0aGlzLm9mZnNldFRvcCA9IHZpZXdwb3J0VG9wICsgdGhpcy5zY3JvbGwucG9zIC0gY2xpZW50VG9wO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm9mZnNldFRvcCA9IDA7XG4gICAgfVxuICB9XG59XG4iXX0=