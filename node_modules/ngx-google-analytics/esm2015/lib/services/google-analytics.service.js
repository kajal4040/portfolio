import { Injectable, Inject, isDevMode } from '@angular/core';
import { NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN } from '../tokens/ngx-google-analytics-settings-token';
import { DOCUMENT } from '@angular/common';
import { NGX_GTAG_FN } from '../tokens/ngx-gtag-token';
import * as i0 from "@angular/core";
import * as i1 from "../tokens/ngx-google-analytics-settings-token";
import * as i2 from "@angular/common";
import * as i3 from "../tokens/ngx-gtag-token";
export class GoogleAnalyticsService {
    constructor(settings, _document, _gtag) {
        this.settings = settings;
        this._document = _document;
        this._gtag = _gtag;
    }
    get document() {
        return this._document;
    }
    throw(err) {
        if ((this.settings.enableTracing || isDevMode()) && console && console.error) {
            console.error(err);
        }
    }
    /** @todo Change this to `Object.fromEntity()` in the future... */
    toKeyValue(map) {
        return (map.size > 0)
            ? Array.from(map).reduce((obj, [key, value]) => Object.defineProperty(obj, key, { value, enumerable: true }), {})
            : undefined;
    }
    /**
     * Call native GA Tag
     */
    gtag(...args) {
        try {
            this._gtag(...args.filter(x => x !== undefined));
        }
        catch (err) {
            this.throw(err);
        }
    }
    /**
     * Send an event trigger to GA. It is the same as call:
     * ```js
     * gtag('event', 'video_auto_play_start', {
     *   'event_label': 'My promotional video',
     *   'event_category': 'video_auto_play'
     * });
     * ```
     *
     * @param action 'video_auto_play_start'
     * @param category 'video_auto_play'
     * @param label 'My promotional video'
     * @param value An value to measure something
     */
    event(action, category, label, value, interaction) {
        try {
            const opt = new Map();
            if (category) {
                opt.set('event_category', category);
            }
            if (label) {
                opt.set('event_label', label);
            }
            if (value) {
                opt.set('value', value);
            }
            if (interaction !== undefined) {
                opt.set('interaction', interaction);
            }
            const params = this.toKeyValue(opt);
            if (params) {
                this.gtag('event', action, params);
            }
            else {
                this.gtag('event', action);
            }
        }
        catch (error) {
            this.throw(error);
        }
    }
    /**
     * Send an page view event. This is the same as
     *
     * ```js
     * gtag('config', 'GA_TRACKING_ID', {
     *   'page_title' : 'Homepage',
     *   'page_path': '/home'
     * });
     * ```
     *
     * The tracking ID is injected automatically by Inject Token NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN
     *
     * @param path /home
     * @param title Homepage
     * @param location '{ page_location }'
     * @param options '{ ... custom dimentions }'
     */
    pageView(path, title, location, options) {
        try {
            const opt = new Map([['page_path', path]]);
            if (title) {
                opt.set('page_title', title);
            }
            if (location || this.document) {
                opt.set('page_location', (location || this.document.location.href));
            }
            if (options) {
                Object
                    .entries(options)
                    .map(([key, value]) => opt.set(key, value));
            }
            this.gtag('config', this.settings.trackingCode, this.toKeyValue(opt));
        }
        catch (error) {
            this.throw(error);
        }
    }
    /**
     * Send an event to report a App Page View. It is the same as
     *
     * ```js
     * gtag('event', 'screen_view', {
     *   'app_name': 'myAppName',
     *   'screen_name' : 'Home'
     * });
     *
     * ```
     *
     * @param screen 'screen_name'
     * @param appName 'app_name'
     * @param appId 'app_id'
     * @param appVersion 'app_version'
     * @param installerId 'app_installer_id'
     */
    appView(screen, appName, appId, appVersion, installerId) {
        try {
            const opt = new Map([['screen_name', screen], ['app_name', appName]]);
            if (appId) {
                opt.set('app_id', appId);
            }
            if (appVersion) {
                opt.set('app_version', appVersion);
            }
            if (installerId) {
                opt.set('app_installer_id', installerId);
            }
            this.gtag('event', 'screen_view', this.toKeyValue(opt));
        }
        catch (error) {
            this.throw(error);
        }
    }
    /**
     * Defines persistent values on GoogleAnalytics
     *
     * @see https://developers.google.com/analytics/devguides/collection/gtagjs/setting-values
     *
     * ```js
     * gtag('set', {
     *   'currency': 'USD',
     *   'country': 'US'
     * });
     * ```
     */
    set(...options) {
        try {
            this._gtag('set', ...options);
        }
        catch (err) {
            this.throw(err);
        }
    }
    /**
     * Send an event to GA to report an application error. It is the same as
     *
     * ```js
     * gtag('event', 'exception', {
     *   'description': 'error_description',
     *   'fatal': false   // set to true if the error is fatal
     * });
     * ```
     *
     * @param description 'error_description'
     * @param fatal set to true if the error is fatal
     */
    exception(description, fatal) {
        try {
            const opt = new Map();
            if (description) {
                opt.set('description', description);
            }
            if (fatal) {
                opt.set('fatal', fatal);
            }
            const params = this.toKeyValue(opt);
            if (params) {
                this.gtag('event', 'exception', this.toKeyValue(opt));
            }
            else {
                this.gtag('event', 'exception');
            }
        }
        catch (error) {
            this.throw(error);
        }
    }
}
GoogleAnalyticsService.ɵprov = i0.ɵɵdefineInjectable({ factory: function GoogleAnalyticsService_Factory() { return new GoogleAnalyticsService(i0.ɵɵinject(i1.NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN), i0.ɵɵinject(i2.DOCUMENT), i0.ɵɵinject(i3.NGX_GTAG_FN)); }, token: GoogleAnalyticsService, providedIn: "root" });
GoogleAnalyticsService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
GoogleAnalyticsService.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [NGX_GOOGLE_ANALYTICS_SETTINGS_TOKEN,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: undefined, decorators: [{ type: Inject, args: [NGX_GTAG_FN,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ29vZ2xlLWFuYWx5dGljcy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uL3Byb2plY3RzL25neC1nb29nbGUtYW5hbHl0aWNzL3NyYy8iLCJzb3VyY2VzIjpbImxpYi9zZXJ2aWNlcy9nb29nbGUtYW5hbHl0aWNzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzlELE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSxNQUFNLCtDQUErQyxDQUFDO0FBR3BHLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sMEJBQTBCLENBQUM7Ozs7O0FBTXZELE1BQU0sT0FBTyxzQkFBc0I7SUFNakMsWUFDZ0UsUUFBa0MsRUFDN0QsU0FBYyxFQUNYLEtBQWE7UUFGVyxhQUFRLEdBQVIsUUFBUSxDQUEwQjtRQUM3RCxjQUFTLEdBQVQsU0FBUyxDQUFLO1FBQ1gsVUFBSyxHQUFMLEtBQUssQ0FBUTtJQUNqRCxDQUFDO0lBUkwsSUFBWSxRQUFRO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUN4QixDQUFDO0lBUU8sS0FBSyxDQUFDLEdBQVU7UUFDdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsYUFBYSxJQUFJLFNBQVMsRUFBRSxDQUFDLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxLQUFLLEVBQUU7WUFDNUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUNwQjtJQUNILENBQUM7SUFFRCxrRUFBa0U7SUFDMUQsVUFBVSxDQUFDLEdBQXFCO1FBQ3RDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUNuQixDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENB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RyxDQUFDLENBQUM7U0FDakI7SUFDSCxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7OztPQVlHO0lBQ0gsU0FBUyxDQUFDLFdBQW9CLEVBQUUsS0FBZTtRQUM3QyxJQUFJO1lBQ0YsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLEVBQWUsQ0FBQztZQUNuQyxJQUFJLFdBQVcsRUFBRTtnQkFDZixHQUFHLENBQUMsR0FBRyxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQzthQUNyQztZQUNELElBQUksS0FBSyxFQUFFO2dCQUNULEdBQUcsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQ3pCO1lBQ0QsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNwQyxJQUFJLE1BQU0sRUFBRTtnQkFDVixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQ3ZEO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFdBQVcsQ0FBQyxDQUFDO2FBQ2pDO1NBQ0Y7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDbkI7SUFDSCxDQUFDOzs7O1lBN01GLFVBQVUsU0FBQztnQkFDVixVQUFVLEVBQUUsTUFBTTthQUNuQjs7OzRDQVFJLE1BQU0sU0FBQyxtQ0FBbUM7NENBQzFDLE1BQU0sU0FBQyxRQUFROzRDQUNmLE1BQU0sU0FBQyxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0LCBpc0Rldk1vZGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE5HWF9HT09HTEVfQU5BTFlUSUNTX1NFVFRJTkdTX1RPS0VOIH0gZnJvbSAnLi4vdG9rZW5zL25neC1nb29nbGUtYW5hbHl0aWNzLXNldHRpbmdzLXRva2VuJztcbmltcG9ydCB7IElHb29nbGVBbmFseXRpY3NTZXR0aW5ncyB9IGZyb20gJy4uL2ludGVyZmFjZXMvaS1nb29nbGUtYW5hbHl0aWNzLXNldHRpbmdzJztcbmltcG9ydCB7IEdhQWN0aW9uRW51bSB9IGZyb20gJy4uL2VudW1zL2dhLWFjdGlvbi5lbnVtJztcbmltcG9ydCB7IERPQ1VNRU5UIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcbmltcG9ydCB7IE5HWF9HVEFHX0ZOIH0gZnJvbSAnLi4vdG9rZW5zL25neC1ndGFnLXRva2VuJztcbmltcG9ydCB7IEd0YWdGbiB9IGZyb20gJy4uL3R5cGVzL2d0YWcudHlwZSc7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIEdvb2dsZUFuYWx5dGljc1NlcnZpY2Uge1xuXG4gIHByaXZhdGUgZ2V0IGRvY3VtZW50KCk6IERvY3VtZW50IHtcbiAgICByZXR1cm4gdGhpcy5fZG9jdW1lbnQ7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KE5HWF9HT09HTEVfQU5BTFlUSUNTX1NFVFRJTkdTX1RPS0VOKSBwcml2YXRlIHJlYWRvbmx5IHNldHRpbmdzOiBJR29vZ2xlQW5hbHl0aWNzU2V0dGluZ3MsXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSByZWFkb25seSBfZG9jdW1lbnQ6IGFueSxcbiAgICBASW5qZWN0KE5HWF9HVEFHX0ZOKSBwcml2YXRlIHJlYWRvbmx5IF9ndGFnOiBHdGFnRm5cbiAgKSB7IH1cblxuICBwcml2YXRlIHRocm93KGVycjogRXJyb3IpIHtcbiAgICBpZiAoKHRoaXMuc2V0dGluZ3MuZW5hYmxlVHJhY2luZyB8fCBpc0Rldk1vZGUoKSkgJiYgY29uc29sZSAmJiBjb25zb2xlLmVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgfVxuICB9XG5cbiAgLyoqIEB0b2RvIENoYW5nZSB0aGlzIHRvIGBPYmplY3QuZnJvbUVudGl0eSgpYCBpbiB0aGUgZnV0dXJlLi4uICovXG4gIHByaXZhdGUgdG9LZXlWYWx1ZShtYXA6IE1hcDxzdHJpbmcsIGFueT4pOiB7IFtwYXJhbTogc3RyaW5nXTogYW55IH0gfCB2b2lkIHtcbiAgICByZXR1cm4gKG1hcC5zaXplID4gMClcbiAgICAgID8gQXJyYXkuZnJvbShtYXApLnJlZHVjZShcbiAgICAgICAgKG9iaiwgW2tleSwgdmFsdWVdKSA9PiBPYmplY3QuZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHsgdmFsdWUsIGVudW1lcmFibGU6IHRydWUgfSksXG4gICAgICAgIHt9XG4gICAgICApXG4gICAgICA6IHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxsIG5hdGl2ZSBHQSBUYWdcbiAgICovXG4gIGd0YWcoLi4uYXJnczogYW55W10pIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5fZ3RhZyguLi5hcmdzLmZpbHRlcih4ID0+IHggIT09IHVuZGVmaW5lZCkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgdGhpcy50aHJvdyhlcnIpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kIGFuIGV2ZW50IHRyaWdnZXIgdG8gR0EuIEl0IGlzIHRoZSBzYW1lIGFzIGNhbGw6XG4gICAqIGBgYGpzXG4gICAqIGd0YWcoJ2V2ZW50JywgJ3ZpZGVvX2F1dG9fcGxheV9zdGFydCcsIHtcbiAgICogICAnZXZlbnRfbGFiZWwnOiAnTXkgcHJvbW90aW9uYWwgdmlkZW8nLFxuICAgKiAgICdldmVudF9jYXRlZ29yeSc6ICd2aWRlb19hdXRvX3BsYXknXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICpcbiAgICogQHBhcmFtIGFjdGlvbiAndmlkZW9fYXV0b19wbGF5X3N0YXJ0J1xuICAgKiBAcGFyYW0gY2F0ZWdvcnkgJ3ZpZGVvX2F1dG9fcGxheSdcbiAgICogQHBhcmFtIGxhYmVsICdNeSBwcm9tb3Rpb25hbCB2aWRlbydcbiAgICogQHBhcmFtIHZhbHVlIEFuIHZhbHVlIHRvIG1lYXN1cmUgc29tZXRoaW5nXG4gICAqL1xuICBldmVudChhY3Rpb246IEdhQWN0aW9uRW51bSB8IHN0cmluZywgY2F0ZWdvcnk/OiBzdHJpbmcsIGxhYmVsPzogc3RyaW5nLCB2YWx1ZT86IG51bWJlciwgaW50ZXJhY3Rpb24/OiBib29sZWFuKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG9wdCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gICAgICBpZiAoY2F0ZWdvcnkpIHtcbiAgICAgICAgb3B0LnNldCgnZXZlbnRfY2F0ZWdvcnknLCBjYXRlZ29yeSk7XG4gICAgICB9XG4gICAgICBpZiAobGFiZWwpIHtcbiAgICAgICAgb3B0LnNldCgnZXZlbnRfbGFiZWwnLCBsYWJlbCk7XG4gICAgICB9XG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgb3B0LnNldCgndmFsdWUnLCB2YWx1ZSk7XG4gICAgICB9XG4gICAgICBpZiAoaW50ZXJhY3Rpb24gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICBvcHQuc2V0KCdpbnRlcmFjdGlvbicsIGludGVyYWN0aW9uKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMudG9LZXlWYWx1ZShvcHQpO1xuICAgICAgaWYgKHBhcmFtcykge1xuICAgICAgICB0aGlzLmd0YWcoJ2V2ZW50JywgYWN0aW9uIGFzIHN0cmluZywgcGFyYW1zKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZ3RhZygnZXZlbnQnLCBhY3Rpb24gYXMgc3RyaW5nKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy50aHJvdyhlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbmQgYW4gcGFnZSB2aWV3IGV2ZW50LiBUaGlzIGlzIHRoZSBzYW1lIGFzXG4gICAqXG4gICAqIGBgYGpzXG4gICAqIGd0YWcoJ2NvbmZpZycsICdHQV9UUkFDS0lOR19JRCcsIHtcbiAgICogICAncGFnZV90aXRsZScgOiAnSG9tZXBhZ2UnLFxuICAgKiAgICdwYWdlX3BhdGgnOiAnL2hvbWUnXG4gICAqIH0pO1xuICAgKiBgYGBcbiAgICpcbiAgICogVGhlIHRyYWNraW5nIElEIGlzIGluamVjdGVkIGF1dG9tYXRpY2FsbHkgYnkgSW5qZWN0IFRva2VuIE5HWF9HT09HTEVfQU5BTFlUSUNTX1NFVFRJTkdTX1RPS0VOXG4gICAqXG4gICAqIEBwYXJhbSBwYXRoIC9ob21lXG4gICAqIEBwYXJhbSB0aXRsZSBIb21lcGFnZVxuICAgKiBAcGFyYW0gbG9jYXRpb24gJ3sgcGFnZV9sb2NhdGlvbiB9J1xuICAgKiBAcGFyYW0gb3B0aW9ucyAneyAuLi4gY3VzdG9tIGRpbWVudGlvbnMgfSdcbiAgICovXG4gIHBhZ2VWaWV3KCBwYXRoOiBzdHJpbmcsIHRpdGxlPzogc3RyaW5nLCBsb2NhdGlvbj86IHN0cmluZywgb3B0aW9ucz86IE9iamVjdCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBvcHQgPSBuZXcgTWFwPHN0cmluZywgYW55PihbWydwYWdlX3BhdGgnLCBwYXRoXV0pO1xuICAgICAgaWYgKHRpdGxlKSB7XG4gICAgICAgIG9wdC5zZXQoJ3BhZ2VfdGl0bGUnLCB0aXRsZSk7XG4gICAgICB9XG4gICAgICBpZiAobG9jYXRpb24gfHwgdGhpcy5kb2N1bWVudCkge1xuICAgICAgICBvcHQuc2V0KCdwYWdlX2xvY2F0aW9uJywgKGxvY2F0aW9uIHx8IHRoaXMuZG9jdW1lbnQubG9jYXRpb24uaHJlZikpO1xuICAgICAgfVxuICAgICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgICAgT2JqZWN0XG4gICAgICAgICAgLmVudHJpZXMob3B0aW9ucylcbiAgICAgICAgICAubWFwKChba2V5LCB2YWx1ZV0pID0+IG9wdC5zZXQoa2V5LCB2YWx1ZSkpO1xuICAgICAgfVxuICAgICAgdGhpcy5ndGFnKCdjb25maWcnLCB0aGlzLnNldHRpbmdzLnRyYWNraW5nQ29kZSwgdGhpcy50b0tleVZhbHVlKG9wdCkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLnRocm93KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2VuZCBhbiBldmVudCB0byByZXBvcnQgYSBBcHAgUGFnZSBWaWV3LiBJdCBpcyB0aGUgc2FtZSBhc1xuICAgKlxuICAgKiBgYGBqc1xuICAgKiBndGFnKCdldmVudCcsICdzY3JlZW5fdmlldycsIHtcbiAgICogICAnYXBwX25hbWUnOiAnbXlBcHBOYW1lJyxcbiAgICogICAnc2NyZWVuX25hbWUnIDogJ0hvbWUnXG4gICAqIH0pO1xuICAgKlxuICAgKiBgYGBcbiAgICpcbiAgICogQHBhcmFtIHNjcmVlbiAnc2NyZWVuX25hbWUnXG4gICAqIEBwYXJhbSBhcHBOYW1lICdhcHBfbmFtZSdcbiAgICogQHBhcmFtIGFwcElkICdhcHBfaWQnXG4gICAqIEBwYXJhbSBhcHBWZXJzaW9uICdhcHBfdmVyc2lvbidcbiAgICogQHBhcmFtIGluc3RhbGxlcklkICdhcHBfaW5zdGFsbGVyX2lkJ1xuICAgKi9cbiAgYXBwVmlldyhzY3JlZW46IHN0cmluZywgYXBwTmFtZTogc3RyaW5nLCBhcHBJZD86IHN0cmluZywgYXBwVmVyc2lvbj86IHN0cmluZywgaW5zdGFsbGVySWQ/OiBzdHJpbmcpIHtcbiAgICB0cnkge1xuICAgICAgY29uc3Qgb3B0ID0gbmV3IE1hcDxzdHJpbmcsIGFueT4oW1snc2NyZWVuX25hbWUnLCBzY3JlZW5dLCBbJ2FwcF9uYW1lJywgYXBwTmFtZV1dKTtcbiAgICAgIGlmIChhcHBJZCkge1xuICAgICAgICBvcHQuc2V0KCdhcHBfaWQnLCBhcHBJZCk7XG4gICAgICB9XG4gICAgICBpZiAoYXBwVmVyc2lvbikge1xuICAgICAgICBvcHQuc2V0KCdhcHBfdmVyc2lvbicsIGFwcFZlcnNpb24pO1xuICAgICAgfVxuICAgICAgaWYgKGluc3RhbGxlcklkKSB7XG4gICAgICAgIG9wdC5zZXQoJ2FwcF9pbnN0YWxsZXJfaWQnLCBpbnN0YWxsZXJJZCk7XG4gICAgICB9XG4gICAgICB0aGlzLmd0YWcoJ2V2ZW50JywgJ3NjcmVlbl92aWV3JywgdGhpcy50b0tleVZhbHVlKG9wdCkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLnRocm93KGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGVmaW5lcyBwZXJzaXN0ZW50IHZhbHVlcyBvbiBHb29nbGVBbmFseXRpY3NcbiAgICpcbiAgICogQHNlZSBodHRwczovL2RldmVsb3BlcnMuZ29vZ2xlLmNvbS9hbmFseXRpY3MvZGV2Z3VpZGVzL2NvbGxlY3Rpb24vZ3RhZ2pzL3NldHRpbmctdmFsdWVzXG4gICAqXG4gICAqIGBgYGpzXG4gICAqIGd0YWcoJ3NldCcsIHtcbiAgICogICAnY3VycmVuY3knOiAnVVNEJyxcbiAgICogICAnY291bnRyeSc6ICdVUydcbiAgICogfSk7XG4gICAqIGBgYFxuICAgKi9cbiAgc2V0KC4uLm9wdGlvbnM6IEFycmF5PGFueT4pIHtcbiAgICB0cnkge1xuICAgICAgdGhpcy5fZ3RhZygnc2V0JywgLi4ub3B0aW9ucyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aGlzLnRocm93KGVycik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlbmQgYW4gZXZlbnQgdG8gR0EgdG8gcmVwb3J0IGFuIGFwcGxpY2F0aW9uIGVycm9yLiBJdCBpcyB0aGUgc2FtZSBhc1xuICAgKlxuICAgKiBgYGBqc1xuICAgKiBndGFnKCdldmVudCcsICdleGNlcHRpb24nLCB7XG4gICAqICAgJ2Rlc2NyaXB0aW9uJzogJ2Vycm9yX2Rlc2NyaXB0aW9uJyxcbiAgICogICAnZmF0YWwnOiBmYWxzZSAgIC8vIHNldCB0byB0cnVlIGlmIHRoZSBlcnJvciBpcyBmYXRhbFxuICAgKiB9KTtcbiAgICogYGBgXG4gICAqXG4gICAqIEBwYXJhbSBkZXNjcmlwdGlvbiAnZXJyb3JfZGVzY3JpcHRpb24nXG4gICAqIEBwYXJhbSBmYXRhbCBzZXQgdG8gdHJ1ZSBpZiB0aGUgZXJyb3IgaXMgZmF0YWxcbiAgICovXG4gIGV4Y2VwdGlvbihkZXNjcmlwdGlvbj86IHN0cmluZywgZmF0YWw/OiBib29sZWFuKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG9wdCA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG4gICAgICBpZiAoZGVzY3JpcHRpb24pIHtcbiAgICAgICAgb3B0LnNldCgnZGVzY3JpcHRpb24nLCBkZXNjcmlwdGlvbik7XG4gICAgICB9XG4gICAgICBpZiAoZmF0YWwpIHtcbiAgICAgICAgb3B0LnNldCgnZmF0YWwnLCBmYXRhbCk7XG4gICAgICB9XG4gICAgICBjb25zdCBwYXJhbXMgPSB0aGlzLnRvS2V5VmFsdWUob3B0KTtcbiAgICAgIGlmIChwYXJhbXMpIHtcbiAgICAgICAgdGhpcy5ndGFnKCdldmVudCcsICdleGNlcHRpb24nLCB0aGlzLnRvS2V5VmFsdWUob3B0KSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLmd0YWcoJ2V2ZW50JywgJ2V4Y2VwdGlvbicpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLnRocm93KGVycm9yKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==